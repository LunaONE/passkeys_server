<html>
  <head>
    <title>Passkeys Server for Dart Demo</title>

    <link rel="stylesheet" href="assets/pico.min.css" />
  </head>

  <body>
    <main class="container">
      <h1>Passkeys Server Demo</h1>

      <p>
        A demo server for the <code>passkeys_server</code> Dart package.<br />
        Get the
        <a href="https://pub.dev/packages/passkeys_server"
          >package on pub.dev</a
        >
        or the
        <a href="https://github.com/LunaONE/passkeys_server"
          >source code on GitHub</a
        >.
      </p>

      <section>
        <h2>Register a new Passkey</h2>

        <article class="component">
          <label
            >Passkey name (local only)

            <input id="pkName" placeholder="Passkey name" />
          </label>

          <button id="btn">Register a new Passkey</button>
        </article>
      </section>

      <section>
        <h2>Log in with existing Passkey</h2>

        <article class="component">
          <button id="btnLogin">Log in with Passkey</button>
        </article>
      </section>

      <section>
        <h2>Debugging functions</h2>

        <article class="component">
          <button id="listKeys" class="outline">List keys</button>

          <div id="adminContent"></div>
        </article>
      </section>

      <hr />

      <p>Built by <a href="https://www.lunaone.de/flutter">LunaONE GmbH</a>.</p>
    </main>

    <script>
      document.getElementById("pkName").value = new Date()
        .toJSON()
        .substring(0, 16);

      function base64ToUint8Array(base64) {
        const binaryString = atob(base64);
        const bytes = new Uint8Array(binaryString.length);
        for (let i = 0; i < binaryString.length; i++) {
          bytes[i] = binaryString.charCodeAt(i);
        }
        return bytes;
      }

      document.getElementById("btn").addEventListener("click", async () => {
        const response = await fetch(`/api/new-user`, {
          method: "POST",
        });
        const responseBody = await response.json();

        const receivedUserId = responseBody["userId"];
        const challenge = base64ToUint8Array(responseBody["challenge"]);
        const userId = base64ToUint8Array(receivedUserId);

        console.log(challenge);
        console.log(userId);

        const publicKey = {
          attestation: "direct",
          challenge: challenge,
          rp: { id: window.location.hostname, name: "passkeys_server Demo" },
          user: {
            id: userId,
            name: document.getElementById("pkName").value,
            displayName: "",
          },
          pubKeyCredParams: [
            // The Windows Hello algorithm
            { type: "public-key", alg: -257 },
            // Works on everything but Windows
            { type: "public-key", alg: -7 },
            // 2 more (RS1 and P-256) are (soon) required https://fidoalliance.org/specs/fido-v2.0-rd-20180702/fido-server-v2.0-rd-20180702.html#other
          ],
        };

        const publicKeyCredential = await navigator.credentials.create({
          publicKey,
        });

        console.log(publicKeyCredential);

        if (publicKeyCredential) {
          const publicKey = publicKeyCredential.toJSON();

          console.log("publicKey JSON");
          console.log(publicKey);

          const params = new URLSearchParams();
          params.append("userId", receivedUserId);
          params.append("keyId", publicKey["id"]);
          params.append(
            "clientDataJSON",
            publicKey["response"]["clientDataJSON"]
          );
          params.append("publicKey", publicKey["response"]["publicKey"]);
          params.append(
            "publicKeyAlgorithm",
            publicKey["response"]["publicKeyAlgorithm"]
          );
          params.append(
            "attestationObject",
            publicKey["response"]["attestationObject"]
          );
          params.append(
            "authenticatorData",
            publicKey["response"]["authenticatorData"]
          );

          const response = await fetch(`/api/finish-registration?${params}`, {
            method: "POST",
          });
        }
      });

      document
        .getElementById("listKeys")
        .addEventListener("click", async () => {
          document.getElementById("adminContent").innerHTML =
            '<span aria-busy="true">Fetching keys...</span>';

          const response = await fetch(`/api/admin/keys`, {
            method: "GET",
          });
          const responseBody = await response.json();

          document.getElementById("adminContent").innerHTML = `
          <div class="overflow-auto">
            <table class="striped" style="white-space: nowrap;">
              <thead>
                <tr>
                  <th scope="col">Key</th>
                  <th scope="col">User</th>
                  <th scope="col">Registered at</th>
                  <th scope="col">Algorithm</th>
                  <th scope="col">Authenticator</th>
                </tr>
              </thead>
              <tbody>
                ${responseBody["keys"]
                  .map(
                    (e) => ` <tr>
                  <th scope="row">${e["keyId"]}</td>
                  <td>${e["userId"]}</td>
                  <td>${e["createdAt"]}</td>
                  <td>${e["algorithm"]}</td>
                  <td>${e["authenticator"]}</td>
                </tr>`
                  )
                  .join(" ")} 
              </tbody>
            </table>
          </div>
          `;
        });

      document
        .getElementById("btnLogin")
        .addEventListener("click", async () => {
          const response = await fetch(`/api/new-user`, {
            method: "POST",
          });
          const responseBody = await response.json();

          const receivedUserId = responseBody["userId"];
          const challenge = base64ToUint8Array(responseBody["challenge"]);
          const userId = base64ToUint8Array(receivedUserId);

          const publicKey = {
            challenge: challenge,
            rpId: window.location.hostname,
            allowCredentials: [],
            userVerification: "required",
          };

          const publicKeyCredential = await navigator.credentials.get({
            publicKey,
          });

          console.log(publicKeyCredential);

          if (publicKeyCredential) {
            const publicKey = publicKeyCredential.toJSON();
            console.log(publicKey);

            const params = new URLSearchParams();
            params.append("loginId", receivedUserId);
            params.append("keyId", publicKey["id"]);
            params.append(
              "clientDataJSON",
              publicKey["response"]["clientDataJSON"]
            );
            params.append("signature", publicKey["response"]["signature"]);
            params.append(
              "authenticatorData",
              publicKey["response"]["authenticatorData"]
            );

            const response = await fetch(`/api/login?${params}`, {
              method: "POST",
            });
          }
        });

      async function importPublicKey(publicKeyDer, algorithm) {
        const publicKey = await window.crypto.subtle.importKey(
          "spki", // format: SubjectPublicKeyInfo (SPKI), DER encoding
          publicKeyDer, // ArrayBuffer containing the DER-encoded public key
          algorithm, // e.g., { name: 'ECDSA', namedCurve: 'P-256' }
          true, // extractable:  whether the key can be extracted later
          ["verify"] // keyUsages:  operations allowed with this key
        );
        return publicKey;
      }

      function base64ToUint8Array(base64) {
        var binaryString = atob(base64);
        var bytes = new Uint8Array(binaryString.length);
        for (var i = 0; i < binaryString.length; i++) {
          bytes[i] = binaryString.charCodeAt(i);
        }
        return bytes;
      }
    </script>
  </body>
</html>
